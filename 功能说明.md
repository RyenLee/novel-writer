# 小说写作工具 - 功能详细说明

## 📚 项目概述

这是一个基于 Rust 开发的专业小说写作工具，专为作家和创作者设计。工具集成了大纲规划、章节管理、版本控制、智能排版等核心功能，帮助作者高效组织创作过程。

## 🎯 核心功能模块

### 1. 📝 **小说与章节管理**

#### 功能描述
- **多小说项目管理**：支持创建和管理多部小说作品
- **树状章节结构**：卷→章→场景的层级结构，支持无限嵌套
- **智能排序系统**：基于路径枚举法的章节排序，支持拖拽调整
- **实时字数统计**：自动计算章节和总字数

#### 使用场景
```rust
// 创建小说结构示例
小说《星辰大海》
├── 第一卷：启程
│   ├── 第1章：命运的相遇 (2,345字)
│   ├── 第2章：未知的挑战 (3,127字)
│   └── 第3章：第一次战斗 (4,215字)
├── 第二卷：成长
│   ├── 第4章：新的伙伴 (2,876字)
│   └── 第5章：秘密训练 (3,542字)
└── 设定资料
    ├── 角色设定
    └── 世界观说明
```

#### 技术特点
- **数据库设计**：使用路径枚举法实现高效树状结构查询
- **实时同步**：章节变更立即更新小说总字数
- **批量操作**：支持章节的批量移动、归档操作

### 2. 🧠 **大纲思维导图** (功能暂未开放)

<!-- 
#### 功能描述
- **多类型节点**：角色、情节、设定、想法、笔记、章节6种节点类型
- **可视化编辑**：拖拽移动、缩放画布、自由布局
- **智能连接**：9种关系类型，支持标签和强度设置
- **章节关联**：思维节点与具体章节的直接关联

#### 节点类型说明
| 类型 | 颜色 | 用途 | 示例 |
|------|------|------|------|
| 👤 角色 | 🔴 红色 | 人物设定 | 主角林风、反派赵无极 |
| 📖 情节 | 🔵 蓝色 | 故事发展 | 秘境探险、宗门大比 |
| 🏰 设定 | 🟢 绿色 | 世界观 | 修仙体系、大陆地图 |
| 💡 想法 | 🟠 橙色 | 灵感记录 | 反转剧情构思 |
| 📝 笔记 | ⚫ 灰色 | 备注信息 | 伏笔提醒、待完善 |
| 📑 章节 | 🟣 紫色 | 章节规划 | 关联具体写作内容 |

#### 连接关系类型
1. **关联关系**（虚线）- 一般联系
2. **依赖关系**（实线）- 前后依赖
3. **时间线**（长虚线）- 时间顺序
4. **层级关系**（粗实线）- 上下级关系
5. **冲突关系**（复杂虚线）- 对立矛盾
6. **爱情关系**（实线）- 感情线
7. **友谊关系**（实线）- 朋友关系
8. **家庭关系**（实线）- 亲属关系
9. **自定义关系**（自定义）- 特殊关系
-->

### 3. 🔄 **版本回溯系统**

#### 功能描述
- **自动版本保存**：定时保存和手动保存两种模式
- **混合存储策略**：快照+差异的智能存储方案
- **版本时间线**：清晰的版本演进历史
- **智能差异比较**：基于文本相似度算法的高效差异计算

#### 版本策略
```rust
// 版本存储示例
版本历史：
v5 (快照) - 2024-01-15 14:30 - "完成第5章" - 完整内容
v4 (差异) - 2024-01-15 14:25 - 自动保存 - 差异数据
v3 (差异) - 2024-01-15 14:20 - 自动保存 - 差异数据
v2 (差异) - 2024-01-15 14:15 - "修改战斗场景" - 差异数据
v1 (快照) - 2024-01-15 14:10 - 初始版本 - 完整内容
```

#### 技术实现
- **差异算法**：使用 `similar` 库进行高性能文本差异计算
- **存储优化**：每10个版本保存一个完整快照，其余保存差异
- **恢复机制**：从最近快照+差异链重建任意版本

### 4. 🎨 **智能排版引擎**

#### 功能描述
- **多语言支持**：中英文混合排版优化
- **标点规范**：自动修正标点符号间距
- **段落格式化**：智能缩进和段落分隔
- **批量处理**：支持整部小说的批量排版

#### 排版规则
| 功能 | 默认启用 | 效果示例 |
|------|----------|----------|
| 多余空格清理 | ✅ | "你好  世界" → "你好 世界" |
| 多余空行清理 | ✅ | "\n\n\n" → "\n\n" |
| 标点间距修正 | ✅ | "你好。世界" → "你好。 世界" |
| 自动段落缩进 | ✅ | "第一章" → "    第一章" |
| 行尾空格清理 | ✅ | "内容 " → "内容" |
| 确保结尾换行 | ✅ | "内容" → "内容\n" |

#### 字数统计
- **总字数**：中文字符数 + 英文单词数
- **中文字数**：纯中文字符统计
- **英文单词**：纯英文单词统计
- **字符总数**：所有字符数量
- **段落统计**：有效段落数量

### 5. 📊 **写作统计与分析**

#### 功能描述
- **进度追踪**：总字数、章节数、写作天数统计
- **连续记录**：连续写作天数和最长连续记录
- **每日统计**：按日期统计写作量和时间
- **目标管理**：写作目标设定和进度监控

#### 统计指标
```rust
写作统计示例：
总字数： 45,678 字
总章节： 12 章
写作天数： 25 天
平均每日： 1,827 字
当前连续： 7 天
最长连续： 15 天
```

#### 目标管理
- **字数目标**：设定总字数目标（如5万字）
- **章节目标**：设定总章节目标（如20章）
- **每日目标**：设定每日写作量（如1000字）
- **截止时间**：设定完成期限

### 6. 🔧 **高级编辑功能**

#### 实时协作特性
- **自动保存**：2秒防抖自动保存，防止数据丢失
- **实时预览**：编辑时实时显示字数变化
- **专注模式**：隐藏界面元素，专注写作内容
- **多主题支持**：浅色、深色、护眼三种主题

#### 搜索与导航
- **章节搜索**：快速定位特定章节
- **内容搜索**：全文内容搜索
- **大纲导航**：通过思维导图快速跳转
- **书签功能**：重要位置标记

## 🛠️ **技术架构说明**

### 数据库设计
```sql
-- 核心表结构
novels (小说表)
chapters (章节表) 
outline_nodes (大纲节点表)
node_connections (节点连接表)
chapter_versions (章节版本表)
```

### 性能优化
1. **数据库优化**
   - WAL模式提升并发性能
   - 合理的索引设计
   - 外键约束保证数据完整性

2. **内存管理**
   - Rust所有权系统避免内存泄漏
   - 智能指针管理复杂数据结构
   - 懒加载减少内存占用

3. **渲染优化**
   - 虚拟化列表处理大量章节
   - Canvas渲染思维导图
   - 增量更新减少重绘

### 错误处理
```rust
// 统一的错误处理机制
pub enum AppError {
    DatabaseError(String),
    FileSystemError(String),
    NetworkError(String),
    ValidationError(String),
}

impl From<rusqlite::Error> for AppError {
    fn from(error: rusqlite::Error) -> Self {
        AppError::DatabaseError(error.to_string())
    }
}
```

## 🎮 **用户交互设计**

### 界面布局
```
┌─────────────────────────────────────────────────┐
│                 标题栏                           │
├─────────────┬───────────────────┬───────────────┤
│             │                   │               │
│   侧边栏    │     编辑区域       │   大纲面板    │
│  章节树     │                   │  思维导图     │
│             │                   │               │
├─────────────┴───────────────────┴───────────────┤
│                 状态栏                           │
└─────────────────────────────────────────────────┘
```

### 快捷键支持
| 功能 | 快捷键 | 说明 |
|------|--------|------|
| 新建章节 | Ctrl+N | 快速创建新章节 |
| 保存 | Ctrl+S | 手动保存当前内容 |
| 搜索 | Ctrl+F | 打开搜索面板 |
| 专注模式 | F11 | 切换专注模式 |
| 思维导图 | Ctrl+M | 切换到思维导图 |

## 📈 **数据安全与备份**

### 数据保护
1. **自动备份**：每小时自动备份数据库
2. **版本冗余**：重要操作创建多个版本
3. **异常恢复**：程序崩溃时自动恢复会话
4. **数据验证**：启动时检查数据库完整性

### 导出功能
- **多种格式**：支持 PDF、DOCX、Markdown 导出
- **自定义模板**：可配置的导出模板
- **批量导出**：整部小说或选定章节导出
- **云端同步**：可选的文件同步功能

## 🔄 **工作流程示例**

### 典型创作流程
1. **规划阶段**
   - 创建新小说项目
   - 在思维导图中构建故事大纲
   - 建立角色关系和情节线

2. **写作阶段**
   - 按照大纲创建章节结构
   - 逐章进行内容创作
   - 使用版本控制记录重要修改

3. **整理阶段**
   - 使用智能排版统一格式
   - 检查统计数据和进度
   - 导出最终稿件

### 协作场景
```rust
// 团队协作示例
主编：
  - 创建小说框架
  - 分配章节给不同作者
  - 审核版本历史
  - 统一排版格式

作者：
  - 负责指定章节写作
  - 使用版本控制记录修改
  - 通过思维导图了解整体结构
  - 查看写作统计调整进度
```

## 🚀 **部署与使用**

### 系统要求
- **操作系统**：Windows 10/11, macOS 10.15+, Linux
- **内存**：最低 4GB，推荐 8GB
- **存储**：至少 500MB 可用空间
- **显卡**：支持 OpenGL 3.0+

### 安装说明
```bash
# 从源码编译
git clone <repository>
cd novel-writer
cargo build --release

# 运行应用
cargo run

# 或直接运行可执行文件
./target/release/novel-writer
```

### 首次使用
1. 启动应用程序
2. 创建第一部小说
3. 熟悉界面布局和基本操作
4. 尝试创建思维导图大纲
5. 开始第一章的写作

这个小说写作工具提供了从构思到完成的完整创作解决方案，帮助作者更好地组织思路、提高写作效率，并确保创作过程的数据安全和可追溯性。